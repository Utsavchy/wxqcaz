<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Mandelbrot Set</title>
<style>
html,body{
  margin:0;
  overflow:hidden;
  background:#0b0b0b;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  touch-action:none;
}
canvas{display:block}

/* ---- Stats ---- */
#stats{
  position:fixed;
  top:10px;
  left:10px;
  font-size:12px;
  color:#aaa;
  line-height:1.4;
  z-index:5;
}

/* ---- Start Modal ---- */
#start{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  backdrop-filter: blur(8px);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:10;
}
#card{
  background:#111;
  border-radius:12px;
  padding:28px;
  width:280px;
  text-align:center;
  box-shadow:0 20px 40px rgba(0,0,0,.5);
}
#card h2{
  margin:0 0 8px;
  color:#fff;
  font-weight:600;
}
#card p{
  margin:0 0 18px;
  font-size:13px;
  color:#999;
}
.btn{
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:none;
  font-size:14px;
  cursor:pointer;
}
.fast{
  background:#1f1f1f;
  color:#ddd;
}
.fast:hover{background:#2a2a2a}
.aa{
  background:#3b82f6;
  color:#fff;
}
.aa:hover{background:#2563eb}
.note{
  margin-top:12px;
  font-size:11px;
  color:#777;
}
</style>
</head>
<body>

<div id="start">
  <div id="card">
    <h2>Mandelbrot</h2>
    <p>Choose rendering quality</p>
    <button class="btn fast" onclick="start(false)">
      Fast mode (no AA)
    </button>
    <button class="btn aa" onclick="start(true)">
      Smooth mode (anti-aliasing)
    </button>
    <div class="note">Smooth mode may lag on mobile</div>
    <div class="note">Due to the 32 bit integer limit, it have limited zoom</div>
  </div>
</div>

<div id="stats">
  FPS: <span id="fps">0</span><br>
  Center: <span id="coord">0 + 0i</span><br>
  Zoom: <span id="zoom">1×</span>
</div>

<canvas id="c"></canvas>

<script>
const canvas=document.getElementById("c");
const fpsEl=fps,coordEl=coord,zoomEl=zoom;
const dpr=Math.max(1,devicePixelRatio||1);

/* ---- Shaders ---- */
const VS=`
attribute vec2 a;
void main(){gl_Position=vec4(a,0,1);}
`;

const FS_FAST=`
precision highp float;
uniform vec2 r,c; uniform float s;
vec3 pal(float t){return .5+.5*cos(6.2831*(t+vec3(0,.33,.67)));}
void main(){
  vec2 z=vec2(0);
  vec2 p=c+(gl_FragCoord.xy-r*.5)*s;
  float i=0.;
  for(float k=0.;k<200.;k++){
    if(dot(z,z)>4.)break;
    z=vec2(z.x*z.x-z.y*z.y,2.*z.x*z.y)+p;
    i++;
  }
  if(i>=200.){gl_FragColor=vec4(0,0,0,1);return;}
  gl_FragColor=vec4(pal(i/200.),1);
}
`;

const FS_AA=`
precision highp float;
uniform vec2 r,c; uniform float s;
vec3 pal(float t){return .5+.5*cos(6.2831*(t+vec3(0,.33,.67)));}
float mandel(vec2 p){
  vec2 z=vec2(0); float i=0.;
  for(float k=0.;k<300.;k++){
    if(dot(z,z)>4.)break;
    z=vec2(z.x*z.x-z.y*z.y,2.*z.x*z.y)+p;
    i++;
  }
  if(i>=300.)return -1.;
  return i;
}
void main(){
  vec2 px=gl_FragCoord.xy;
  vec2 o[4];
  o[0]=vec2(.25,.25); o[1]=vec2(.75,.25);
  o[2]=vec2(.25,.75); o[3]=vec2(.75,.75);
  vec3 col=vec3(0);
  for(int i=0;i<4;i++){
    vec2 p=c+(px+o[i]-r*.5)*s;
    float m=mandel(p);
    if(m>=0.) col+=pal(m/300.);
  }
  gl_FragColor=vec4(col/4.,1);
}
`;

function start(useAA){
  document.getElementById("start").remove();
  init(useAA);
}

function init(useAA){
  canvas.width=innerWidth*dpr;
  canvas.height=innerHeight*dpr;
  canvas.style.width=innerWidth+"px";
  canvas.style.height=innerHeight+"px";

  const gl=canvas.getContext("webgl");
  function sh(t,s){
    const x=gl.createShader(t);
    gl.shaderSource(x,s);
    gl.compileShader(x);
    return x;
  }
  const prog=gl.createProgram();
  gl.attachShader(prog,sh(gl.VERTEX_SHADER,VS));
  gl.attachShader(prog,sh(gl.FRAGMENT_SHADER,useAA?FS_AA:FS_FAST));
  gl.linkProgram(prog);
  gl.useProgram(prog);

  const buf=gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER,buf);
  gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,1,1]),gl.STATIC_DRAW);
  const a=gl.getAttribLocation(prog,"a");
  gl.enableVertexAttribArray(a);
  gl.vertexAttribPointer(a,2,gl.FLOAT,false,0,0);

  const rLoc=gl.getUniformLocation(prog,"r");
  const cLoc=gl.getUniformLocation(prog,"c");
  const sLoc=gl.getUniformLocation(prog,"s");

  let cx=-.5,cy=0,tcx=cx,tcy=cy;
  let s=4/canvas.width,ts=s;

  canvas.onwheel=e=>{e.preventDefault();ts*=e.deltaY<0?.8:1.25};

  let drag=false,lx=0,ly=0;
  canvas.onmousedown=e=>{drag=true;lx=e.clientX*dpr;ly=e.clientY*dpr};
  window.onmouseup=()=>drag=false;
  window.onmousemove=e=>{
    if(!drag)return;
    const x=e.clientX*dpr,y=e.clientY*dpr;
    tcx-=(x-lx)*s; tcy+=(y-ly)*s;
    lx=x; ly=y;
  };

  let last=performance.now(),f=0,aT=0;
  function loop(n){
    cx+=(tcx-cx)*.15; cy+=(tcy-cy)*.15; s+=(ts-s)*.15;
    gl.viewport(0,0,canvas.width,canvas.height);
    gl.uniform2f(rLoc,canvas.width,canvas.height);
    gl.uniform2f(cLoc,cx,cy);
    gl.uniform1f(sLoc,s);
    gl.drawArrays(gl.TRIANGLE_STRIP,0,4);

    f++; aT+=n-last; last=n;
    if(aT>500){
      fpsEl.textContent=(f*1000/aT)|0;
      coordEl.textContent=cx.toFixed(5)+" + "+cy.toFixed(5)+"i";
      zoomEl.textContent=(4/s).toFixed(1)+"×";
      f=0; aT=0;
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
